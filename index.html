<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conferência de Pallets</title>

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --border:#1f2937;
    --white:#e5e7eb; --good:#22c55e; --warn:#f59e0b;
    /* tons para zebra */
    --row-dark:#0c1426;
    --row-light:#141d31;
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg, var(--bg), #000);
    color:var(--white); font:500 15px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
  }
  .wrap{max-width:1100px; margin:18px auto; padding:0 10px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.25); overflow:hidden;}
  header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 12px 6px 12px;}
  h1{font-size:18px; margin:0}
  .muted{color:var(--muted); font-weight:400}
  .btn{
    appearance:none; border:1px solid var(--border); border-radius:10px; padding:7px 10px;
    background:linear-gradient(90deg,#0891b2,#06b6d4); color:#001016; cursor:pointer; font-size:13px; font-weight:700;
  }
  .input, select{
    background:#0b1220; border:1px solid var(--border); border-radius:10px; color:var(--white);
    padding:7px 9px; min-width:200px; font-size:13px;
  }
  select{width:100%}
  table{width:100%; border-collapse:collapse}
  thead th{
    position:sticky; top:0; background:var(--panel);
    text-align:left; font-weight:700; color:#cbd5e1; font-size:12px; text-transform:uppercase; letter-spacing:.06em;
    border-bottom:1px solid var(--border); padding:8px 9px; z-index:1;
  }
  tbody tr:nth-child(odd){ background:var(--row-dark) }
  tbody tr:nth-child(even){ background:var(--row-light) }
  tbody td{border-top:1px dashed #1b2233; padding:8px 9px; vertical-align:middle}
  tbody tr:hover{filter:brightness(1.05)}
  .number{width:110px}
  .readonly{background:#0a1323; border:1px solid #192234; color:#cbd5e1; border-radius:8px; padding:7px 8px}
  .flex{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  .pill{padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#0b1220; white-space:nowrap}
  .pill.good{border-color:rgba(34,197,94,.35); color:var(--good)}
  .pill.warn{border-color:rgba(245,158,11,.35); color:#fbbf24}
  tfoot td{border-top:2px solid var(--border); padding:9px}
  .right{text-align:right}
  .small{font-size:12px; color:var(--muted)}

  /* Compacto */
  @media (max-width:768px){
    .wrap{margin:10px auto; padding:0 8px}
    header{padding:10px}
    h1{font-size:17px}
    .input, select{min-width:150px; font-size:13px; padding:7px 8px}
    thead th{font-size:11px; padding:7px}
    tbody td{padding:7px}
    .number{width:88px}
    .readonly{padding:6px 7px}
  }
  /* Celular (cartões) */
  @media (max-width:480px){
    table, thead, tbody, tfoot, th, td, tr{display:block}
    thead{display:none}
    tbody tr{border-top:1px solid var(--border); padding:8px 6px}
    tbody td{border:none; padding:6px 4px}
    tbody td .label{display:block; font-size:11px; color:#93a4bd; margin-bottom:4px; text-transform:uppercase; letter-spacing:.04em}
    .number{width:100%}
    .flex{gap:4px}
    td[data-col="detalhe"]{display:none} /* esconde coluna de detalhe no mobile para caber */
    tfoot tr{display:grid; grid-template-columns:1fr 1fr; gap:6px; padding:8px}
    tfoot td{border:none; padding:6px}
    .right{text-align:left}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>Conferência de Pallets</h1>
          <div class="muted">Selecione até 20 produtos e informe a quantidade da nota.</div>
        </div>
        <button class="btn" id="btnLimpar">Limpar</button>
      </header>

      <!-- Toolbar e banners REMOVIDOS/OCULTOS conforme solicitado -->

      <div style="padding:0 12px 8px 12px" class="small">
        <span class="pill">Regra</span> Pallets = <strong>Qtd. da Nota ÷ Caixas/Pallet</strong>.
      </div>

      <div style="overflow:auto">
        <table id="tabela">
          <thead>
            <tr>
              <th style="min-width:320px">Produto</th>
              <th class="right number">Caixas/Pallet</th>
              <th class="right number">Qtd. da Nota</th>
              <th class="right number">Pallets (total)</th>
              <th style="min-width:220px">Detalhe</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td class="right"><strong>Totais:</strong></td>
              <td class="right"><span id="totalCaixasPallet" class="small muted">—</span></td>
              <td class="right"><strong id="totalCaixasNota">0</strong></td>
              <td class="right"><strong id="totalPallets">0</strong></td>
              <td class="right"><span id="resumoCheiosResto" class="small muted">—</span></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

<script>
/* =================== CONFIG =================== */
/* Caminho fixo do CSV no GitHub Pages (ajuste se necessário) */
const CSV_PATH = 'https://logisticaincobel.github.io/confersku/produtos.csv';

/* =================== Utilidades =================== */
const byId = id => document.getElementById(id);
const fmt = n => Number.isFinite(n) ? n.toLocaleString('pt-BR', {maximumFractionDigits:2}) : '';
const toNumber = v => (v===0||v) ? Number(String(v).replace(/\uFEFF/g,'').replace(/\./g,'').replace(',', '.')) : NaN;

/* =================== CSV =================== */
let produtos = [];              // [{nome, caixasPorPallet}]
let mapa = new Map();           // nome -> caixasPorPallet
const MAX_LINHAS = 20;

function detectDelimiter(line){
  const c = (line.match(/,/g)||[]).length, s=(line.match(/;/g)||[]).length;
  return s>c?';':',';
}
async function carregarCSVTexto(csvText){
  const linhas = csvText.replace(/^\uFEFF/, '').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if (!linhas.length) return [];
  const delim = detectDelimiter(linhas[0]);
  const out = [];
  for (let i=0;i<linhas.length;i++){
    const parts = linhas[i]
      .split(new RegExp(`${delim}(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)`))
      .map(s => s.replace(/^"|"$/g,'').trim());
    if (i===0 && (parts[0]||'').toLowerCase().includes('produto')) continue;
    if (parts.length<2) continue;
    const nome = parts[0];
    const caixas = toNumber(parts[1]);
    if (!nome || !Number.isFinite(caixas)) continue;
    out.push({nome, caixasPorPallet: caixas});
  }
  return out;
}
async function carregarDeURL(url){
  const res = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now()); // cache bust
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const text = await res.text();
  return carregarCSVTexto(text);
}

/* =================== UI =================== */
function labelDiv(txt){ const d=document.createElement('div'); d.className='label'; d.textContent=txt; return d; }

function criarLinha(i){
  const tr = document.createElement('tr');

  const tdProduto = document.createElement('td');
  tdProduto.appendChild(labelDiv('Produto'));
  const sel = document.createElement('select');
  sel.className = 'input'; tdProduto.appendChild(sel);

  const tdCx = document.createElement('td'); tdCx.className='right';
  tdCx.appendChild(labelDiv('Caixas/Pallet'));
  const cx = document.createElement('input'); cx.className='readonly number'; cx.readOnly=true; cx.placeholder='—';
  tdCx.appendChild(cx);

  const tdQtd = document.createElement('td'); tdQtd.className='right';
  tdQtd.appendChild(labelDiv('Qtd. da Nota'));
  const qtd = document.createElement('input'); qtd.type='number'; qtd.min='0'; qtd.step='1'; qtd.className='input number'; qtd.placeholder='0';
  tdQtd.appendChild(qtd);

  const tdPal = document.createElement('td'); tdPal.className='right';
  tdPal.appendChild(labelDiv('Pallets (total)'));
  const pal = document.createElement('div'); pal.className='readonly number'; pal.style.textAlign='right';
  tdPal.appendChild(pal);

  const tdDet = document.createElement('td'); tdDet.dataset.col='detalhe';
  tdDet.appendChild(labelDiv('Detalhe'));
  const detalhes = document.createElement('div'); detalhes.className='flex';
  const pillCheios = document.createElement('span'); pillCheios.className='pill';
  const pillResto = document.createElement('span'); pillResto.className='pill';
  detalhes.appendChild(pillCheios); detalhes.appendChild(pillResto);
  tdDet.appendChild(detalhes);

  tr.append(tdProduto, tdCx, tdQtd, tdPal, tdDet);

  sel.addEventListener('change', ()=>{
    const nome = sel.value;
    if (mapa.has(nome)){ cx.value = fmt(mapa.get(nome)); if (!qtd.value) qtd.focus(); }
    else { cx.value=''; }
    recalcular();
  });
  qtd.addEventListener('input', recalcular);

  function recalcular(){
    const c = toNumber(cx.value), q = toNumber(qtd.value);
    if (Number.isFinite(c) && c>0 && Number.isFinite(q) && q>=0){
      const total = q/c; pal.textContent = fmt(total);
      const cheios = Math.floor(total); const resto = q - cheios*c;
      pillCheios.textContent = cheios+' cheio(s)'; pillResto.textContent = resto+' caixa(s) resto';
      const cls = 'pill ' + (resto===0?'good':'warn'); pillCheios.className=cls; pillResto.className=cls;
    }else{
      pal.textContent=''; pillCheios.textContent='—'; pillResto.textContent='—'; pillCheios.className='pill'; pillResto.className='pill';
    }
    atualizarTotais();
  }

  return tr;
}

function montarLinhas(){
  const tbody = byId('tbody'); tbody.innerHTML='';
  for (let i=0;i<MAX_LINHAS;i++) tbody.appendChild(criarLinha(i+1));
  montarOpcoesSelect();
}

function montarOpcoesSelect(){
  const selects = byId('tbody').querySelectorAll('select');
  for (const sel of selects){
    const prev = sel.value;
    sel.innerHTML='';
    const opt0 = document.createElement('option');
    opt0.value=''; opt0.textContent = produtos.length?'Selecione um produto…':'Carregando base…'; opt0.disabled=true; opt0.selected=true;
    sel.appendChild(opt0);
    for (const p of produtos){
      const o=document.createElement('option'); o.value=p.nome; o.textContent=p.nome; sel.appendChild(o);
    }
    if (prev && mapa.has(prev)){ sel.value=prev; sel.dispatchEvent(new Event('change')); }
  }
}

function atualizarTotais(){
  const linhas = [...byId('tbody').querySelectorAll('tr')];
  let totalNota=0, totalPallets=0, totalCheios=0, totalResto=0;
  for (const tr of linhas){
    const caixas = toNumber(tr.children[1].querySelector('input').value);
    const qtd = toNumber(tr.children[2].querySelector('input').value);
    if (!Number.isFinite(qtd)) continue;
    totalNota += qtd;
    if (Number.isFinite(caixas) && caixas>0){
      const total = qtd/caixas; totalPallets += total;
      const cheios = Math.floor(total); const resto = qtd - cheios*caixas;
      totalCheios += cheios; totalResto += resto;
    }
  }
  byId('totalCaixasNota').textContent = fmt(totalNota);
  byId('totalPallets').textContent = fmt(totalPallets);
  byId('resumoCheiosResto').textContent = `${fmt(totalCheios)} cheio(s) • ${fmt(totalResto)} caixa(s) de resto`;
}

/* =================== Boot =================== */
async function main(){
  montarLinhas();
  try{
    const lista = await carregarDeURL(CSV_PATH);
    produtos = lista.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR',{sensitivity:'base'}));
    mapa = new Map(produtos.map(p=>[p.nome,p.caixasPorPallet]));
    montarOpcoesSelect();
  }catch(e){
    console.warn('Falha ao carregar CSV:', e);
    // silencioso, conforme solicitado (sem banners/avisos)
  }
}
byId('btnLimpar').addEventListener('click', ()=>{ montarLinhas(); atualizarTotais(); });
main();
</script>
</body>
</html>
