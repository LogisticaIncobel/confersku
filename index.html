<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conferência de Pallets</title>

<!-- SheetJS opcional para XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --border:#1f2937;
    --accent:#22d3ee; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --white:#e5e7eb;
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg, var(--bg), #000);
    color:var(--white); font:500 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
  }
  .wrap{max-width:1200px; margin:20px auto; padding:0 12px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.25); overflow:hidden;}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 14px 8px 14px;}
  h1{font-size:20px; margin:0}
  .muted{color:var(--muted); font-weight:400}
  .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:0 14px 12px 14px;}
  .btn, .file{
    appearance:none; border:1px solid var(--border); border-radius:10px; padding:9px 12px;
    background:#0b1220; color:var(--white); cursor:pointer; font-size:14px;
  }
  .btn:hover{border-color:#2b3648}
  .btn.accent{border-color:transparent; background:linear-gradient(90deg, #0891b2, #06b6d4); color:#001016; font-weight:700}
  .input, select{
    background:#0b1220; border:1px solid var(--border); border-radius:10px; color:var(--white);
    padding:9px 11px; min-width:220px; font-size:14px;
  }
  select{width:100%}
  .hint{font-size:12px; color:var(--muted); margin-left:4px}
  table{width:100%; border-collapse:collapse}
  thead th{
    position:sticky; top:0; background:var(--panel);
    text-align:left; font-weight:700; color:#cbd5e1; font-size:12px; text-transform:uppercase; letter-spacing:.06em;
    border-bottom:1px solid var(--border); padding:10px 10px;
    z-index:1;
  }
  tbody td{border-top:1px dashed #1b2233; padding:8px 10px; vertical-align:middle}
  tbody tr:hover{background:#0c1426}
  .number{width:110px}
  .readonly{background:#0a1323; border:1px solid #192234; color:#cbd5e1; border-radius:8px; padding:8px 9px}
  .flex{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  .pill{padding:5px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#0b1220; white-space:nowrap}
  .pill.good{border-color:rgba(34,197,94,.35); color:var(--good)}
  .pill.warn{border-color:rgba(245,158,11,.35); color:var(--warn)}
  tfoot td{border-top:2px solid var(--border); padding:10px}
  .right{text-align:right}
  .grid2{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .small{font-size:12px; color:var(--muted)}
  .footnote{padding:10px 14px 16px 14px}

  /* ======= Modo compacto para telas pequenas ======= */
  @media (max-width: 880px){
    .wrap{margin:10px auto; padding:0 8px}
    header{padding:12px 10px 6px 10px}
    .toolbar{padding:0 10px 10px 10px}
    h1{font-size:18px}
    .input, select{min-width:180px; font-size:13.5px; padding:8px 10px}
    .btn, .file{font-size:13.5px; padding:8px 10px}
    thead th{font-size:11px; padding:8px}
    tbody td{padding:8px}
    .number{width:92px}
    .readonly{padding:7px 8px}
  }

  /* ======= Layout "cartões" no celular (visão ampla) ======= */
  @media (max-width: 560px){
    table, thead, tbody, tfoot, th, td, tr{display:block}
    thead{display:none}
    tbody tr{border-top:1px solid var(--border); padding:8px 6px}
    tbody td{border:none; padding:6px 4px}
    tbody td .label{display:block; font-size:11px; color:#93a4bd; margin-bottom:4px; text-transform:uppercase; letter-spacing:.04em}
    .number{width:100%}
    .flex{gap:4px}
    tfoot tr{display:grid; grid-template-columns:1fr 1fr; gap:6px; padding:8px}
    tfoot td{border:none; padding:6px}
    .right{text-align:left}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>Conferência de Pallets</h1>
          <div class="muted">Selecione até 20 produtos do arquivo e informe a quantidade da nota para ver os pallets.</div>
        </div>
        <button class="btn accent" id="btnLimpar">Limpar tudo</button>
      </header>

      <div class="toolbar">
        <div class="grid2" style="min-width:280px">
          <input id="urlCSV" class="input" placeholder="Caminho do produtos.csv (opcional)" />
          <button class="btn" id="btnCarregarURL">Carregar CSV</button>
        </div>
        <div class="grid2" style="min-width:280px">
          <input type="file" id="filePicker" class="file" accept=".csv,.xlsx,.xls" />
          <span class="hint">Ou deixe <code>produtos.csv</code> na mesma pasta.</span>
        </div>
      </div>

      <div style="padding:0 14px 10px 14px" class="small">
        <span class="pill">Regra de cálculo</span> Pallets = <strong>Quantidade da Nota ÷ Caixas/Pallet</strong>.
        Mostramos também <em>pallets cheios</em> e <em>caixas restantes</em>.
      </div>

      <div style="overflow:auto">
        <table id="tabela">
          <thead>
            <tr>
              <th style="min-width:320px">Produto</th>
              <th class="right number">Caixas por Pallet</th>
              <th class="right number">Qtd. da Nota</th>
              <th class="right number">Pallets (total)</th>
              <th style="min-width:220px">Detalhe</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td class="right"><strong>Totais:</strong></td>
              <td class="right"><span id="totalCaixasPallet" class="small muted">—</span></td>
              <td class="right"><strong id="totalCaixasNota">0</strong></td>
              <td class="right"><strong id="totalPallets">0</strong></td>
              <td class="right"><span id="resumoCheiosResto" class="small muted">—</span></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="footnote small">
        <strong>Carregamento automático:</strong> este painel procura por <code>produtos.csv</code> na mesma pasta do <code>index.html</code> (GitHub Pages).
      </div>
    </div>
  </div>

<script>
/** ================== Utilidades =================== */
const byId = id => document.getElementById(id);
const fmt = n => Number.isFinite(n) ? n.toLocaleString('pt-BR', {maximumFractionDigits: 2}) : '';
const toNumber = v => {
  if (typeof v === 'number') return v;
  if (!v) return NaN;
  return Number(String(v).replace(/\./g,'').replace(',', '.'));
};

/** ================== Base de produtos =================== */
let produtos = []; // [{nome, caixasPorPallet}]
let mapa = new Map(); // nome -> caixasPorPallet
const MAX_LINHAS = 20;

/* Resolve a URL padrão do CSV respeitando subpastas do GitHub Pages */
function defaultCSVUrl(){
  // caminho da pasta atual (sem o arquivo no final)
  const base = location.pathname.replace(/[^/]*$/, '');
  return base + 'produtos.csv';
}

async function carregarCSVTexto(csvText){
  const linhas = csvText.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  for (let i=0;i<linhas.length;i++){
    // separa por vírgula ignorando vírgulas dentro de aspas
    const parts = linhas[i].split(/,(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g,'').trim());
    if (i===0 && parts[0]?.toLowerCase().includes('produto')) continue; // cabeçalho
    if (parts.length < 2) continue;
    const nome = parts[0];
    const caixas = toNumber(parts[1]);
    if (!nome || !Number.isFinite(caixas)) continue;
    out.push({nome, caixasPorPallet: caixas});
  }
  return out;
}

async function carregarDeURL(url){
  const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now()); // cache-busting
  if (!res.ok) throw new Error('Não foi possível baixar o arquivo em ' + url);
  const text = await res.text();
  return await carregarCSVTexto(text);
}

async function carregarDeArquivo(arquivo){
  const nome = arquivo.name.toLowerCase();
  if (nome.endsWith('.csv')){
    const text = await arquivo.text();
    return await carregarCSVTexto(text);
  } else {
    const data = await arquivo.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});
    const csv = rows.map(r => r.map(x => String(x)).join(',')).join('\n');
    return await carregarCSVTexto(csv);
  }
}

function atualizarMapa(prodList){
  produtos = prodList.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR',{sensitivity:'base'}));
  mapa = new Map(produtos.map(p=>[p.nome, p.caixasPorPallet]));
  montarOpcoesSelect(); // atualiza todas as listas
}

/** ================== UI: Linhas e cálculos =================== */
function labelDiv(texto){
  const d = document.createElement('div');
  d.className = 'label';
  d.textContent = texto;
  return d;
}

function criarLinha(index){
  const tr = document.createElement('tr');

  // Produto (SELECT com opções do CSV)
  const tdProduto = document.createElement('td');
  tdProduto.appendChild(labelDiv('Produto'));
  const selectProduto = document.createElement('select');
  selectProduto.className = 'input';
  selectProduto.dataset.idx = index;
  tdProduto.appendChild(selectProduto);

  // Caixas por pallet (readonly)
  const tdCaixas = document.createElement('td'); tdCaixas.className = 'right';
  tdCaixas.appendChild(labelDiv('Caixas por Pallet'));
  const caixas = document.createElement('input');
  caixas.type = 'text'; caixas.readOnly = true; caixas.className = 'readonly number';
  caixas.placeholder = '—';
  tdCaixas.appendChild(caixas);

  // Qtd da nota (digitável)
  const tdQtd = document.createElement('td'); tdQtd.className = 'right';
  tdQtd.appendChild(labelDiv('Qtd. da Nota'));
  const qtd = document.createElement('input');
  qtd.type = 'number'; qtd.min = '0'; qtd.step = '1'; qtd.className = 'input number';
  qtd.placeholder = '0';
  tdQtd.appendChild(qtd);

  // Pallets (total)
  const tdPallets = document.createElement('td'); tdPallets.className = 'right';
  tdPallets.appendChild(labelDiv('Pallets (total)'));
  const pallets = document.createElement('div');
  pallets.className = 'readonly number'; pallets.style.textAlign='right';
  pallets.textContent = '';
  tdPallets.appendChild(pallets);

  // Detalhe (cheios + resto)
  const tdDetalhe = document.createElement('td');
  tdDetalhe.appendChild(labelDiv('Detalhe'));
  const detalhe = document.createElement('div'); detalhe.className='flex';
  const pillCheios = document.createElement('span'); pillCheios.className='pill';
  const pillResto = document.createElement('span'); pillResto.className='pill';
  detalhe.appendChild(pillCheios); detalhe.appendChild(pillResto);
  tdDetalhe.appendChild(detalhe);

  tr.appendChild(tdProduto); tr.appendChild(tdCaixas); tr.appendChild(tdQtd); tr.appendChild(tdPallets); tr.appendChild(tdDetalhe);

  // Eventos
  selectProduto.addEventListener('change', ()=>{
    const nome = selectProduto.value;
    if (mapa.has(nome)){
      const cx = mapa.get(nome);
      caixas.value = fmt(cx);
      if (!qtd.value) qtd.focus();
    } else {
      caixas.value = '';
    }
    recalcular();
  });
  qtd.addEventListener('input', ()=> recalcular());

  function recalcular(){
    const cx = toNumber(caixas.value);
    const q = toNumber(qtd.value);
    if (Number.isFinite(cx) && cx>0 && Number.isFinite(q) && q>=0){
      const total = q / cx;
      pallets.textContent = fmt(total);
      const cheios = Math.floor(total);
      const restoCaixas = q - cheios*cx;
      pillCheios.textContent = cheios+' pallet(s) cheio(s)';
      pillResto.textContent = (restoCaixas)+' caixa(s) resto';
      pillCheios.className = 'pill ' + (restoCaixas===0 ? 'good':'warn');
      pillResto.className  = 'pill ' + (restoCaixas===0 ? 'good':'warn');
    } else {
      pallets.textContent = '';
      pillCheios.textContent = '—';
      pillResto.textContent = '—';
      pillCheios.className='pill';
      pillResto.className='pill';
    }
    atualizarTotais();
  }

  return tr;
}

function montarLinhas(){
  const tbody = byId('tbody');
  tbody.innerHTML = '';
  for (let i=0;i<MAX_LINHAS;i++){
    tbody.appendChild(criarLinha(i+1));
  }
  montarOpcoesSelect(); // preenche selects existentes com a base atual (se houver)
}

function montarOpcoesSelect(){
  const selects = byId('tbody').querySelectorAll('select');
  for (const sel of selects){
    const valorAtual = sel.value;
    sel.innerHTML = ''; // limpa
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = 'Selecione um produto...';
    opt0.disabled = true; opt0.selected = true;
    sel.appendChild(opt0);
    for (const p of produtos){
      const opt = document.createElement('option');
      opt.value = p.nome;
      opt.textContent = p.nome;
      sel.appendChild(opt);
    }
    // tenta restaurar escolha se ainda existir
    if (valorAtual && mapa.has(valorAtual)){
      sel.value = valorAtual;
      sel.dispatchEvent(new Event('change'));
    }
  }
}

function atualizarTotais(){
  const linhas = [...byId('tbody').querySelectorAll('tr')];
  let totalNota = 0;
  let totalPallets = 0;
  let totalCheios = 0;
  let totalRestoCx = 0;

  for (const tr of linhas){
    const caixas = toNumber(tr.children[1].querySelector('input').value);
    const qtd = toNumber(tr.children[2].querySelector('input').value);
    if (!Number.isFinite(qtd)) continue;
    totalNota += qtd;
    if (Number.isFinite(caixas) && caixas>0){
      const total = qtd / caixas;
      totalPallets += total;
      const cheios = Math.floor(total);
      const resto = qtd - cheios*caixas;
      totalCheios += cheios;
      totalRestoCx += resto;
    }
  }
  byId('totalCaixasNota').textContent = fmt(totalNota);
  byId('totalPallets').textContent = fmt(totalPallets);
  byId('resumoCheiosResto').textContent = `${fmt(totalCheios)} pallet(s) cheio(s) • ${fmt(totalRestoCx)} caixa(s) de resto`;
}

/** ================== Carregamento inicial =================== */
async function tentarCarregarAutomatico(){
  const url = defaultCSVUrl();
  try{
    const lista = await carregarDeURL(url);
    atualizarMapa(lista);
  }catch(e){
    console.warn('CSV não encontrado em', url, e);
    // mantém vazio até o usuário carregar manualmente
  }
}

byId('btnCarregarURL').addEventListener('click', async ()=>{
  const url = byId('urlCSV').value.trim();
  if (!url) { alert('Informe a URL/caminho do CSV.'); return; }
  try{
    const lista = await carregarDeURL(url);
    atualizarMapa(lista);
    alert('Base carregada com sucesso!');
  }catch(e){
    alert('Falha ao carregar: ' + e.message);
  }
});

byId('filePicker').addEventListener('change', async (ev)=>{
  const file = ev.target.files?.[0];
  if (!file) return;
  try{
    const lista = await carregarDeArquivo(file);
    atualizarMapa(lista);
    alert('Base carregada com sucesso!');
  }catch(e){
    alert('Falha ao ler arquivo: ' + e.message);
  }
});

byId('btnLimpar').addEventListener('click', ()=>{
  montarLinhas();
  atualizarTotais();
});

(async function main(){
  montarLinhas();
  await tentarCarregarAutomatico();
})();
</script>
</body>
</html>
